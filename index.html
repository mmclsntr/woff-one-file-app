<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WOFF Starter</title>
        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    </head>
    <body>
        <!-- VConsole -->
        <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
        <script>
            // VConsole will be exported to `window.VConsole` by default.
            var vConsole = new window.VConsole();
        </script>
        <!-- WOFF SDK -->
        <script charset="utf-8" src="https://static.worksmobile.net/static/wm/woff/edge/3.6/sdk.js"></script>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>


        <div class="container-fluid">
            <!-- WOFF ID ERROR -->
            <div id="woffIdErrorMessage" hidden>
                <p>You have not assigned any value for WOFF ID.</p>
                <p>If you are using any other platform, please add your WOFF ID.</p>
            </div>
            <!-- WOFF INIT ERROR -->
            <div id="woffInitErrorMessage" hidden>
                <p>Something went wrong with WOFF initialization.</p>
                <p>WOFF initialization can fail if a user clicks "Cancel" on the "Grant permission" screen, or if an error occurs in the process of <code>woff.init()</code>.</p>
            </div>
            <!-- NODE.JS WOFF ID ERROR -->
            <div id="nodeWoffIdErrorMessage" hidden>
                <p>Unable to receive the WOFF ID as an environment variable.</p>
            </div>

            <div class="row p-1">
                <div class="col">
                    <!-- LOGIN LOGOUT BUTTONS -->
                    <div class="buttonGroup">
                        <button id="woffLoginButton" class="btn btn-primary">Log in</button>
                        <button id="woffLogoutButton" class="btn btn-primary">Log out</button>
                    </div>
                    <div id="statusMessage">
                        <div id="isInClientMessage"></div>
                        <div id="apiReferenceMessage">
                            <p>Available WOFF methods vary depending on the browser you use to open the WOFF app.</p>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <!-- Send Message -->
                <h2>Send message</h2>
                <input type="text" value="Sent from WOFF" name="message" id="sendMessageText">
                <button id="sendMessageButton" class="btn btn-primary">Send Message</button>
            </div>

            <hr>

            <div class="row p-1">
                <!-- PROFILE INFO -->
                <h2>Profile</h2>
                <button id="getProfileButton" class="btn btn-primary">Get Profile</button>
                <div class="table-responsive">
                    <table class="table">
                        <tr>
                            <th>domainId</th>
                            <td id="domainIdField"></td>
                        </tr>
                        <tr>
                            <th>userId</th>
                            <td id="userIdProfileField"></td>
                        </tr>
                        <tr>
                            <th>displayName</th>
                            <td id="displayNameField"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <!-- SCAN QR -->
                <h2>Scan QR</h2>
                <button id="scanQrButton" class="btn btn-primary">Scan QR</button>
                <div class="table-responsive">
                    <table class="table">
                        <tr>
                            <th>Scan result</th>
                            <td id="scanQrResult"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <div class="col">
                    <!-- Context -->
                    <div id="woffContext">
                        <h2 id="woffContextHeader" class="textLeft">WOFF Context</h2>
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <th>View Type</th>
                                    <td id="viewType" class="textLeft"></td>
                                </tr>
                                <tr>
                                    <th>Endpoint URL</th>
                                    <td id="endpointUrl" class="textLeft"></td>
                                </tr>
                                <tr>
                                    <th>Permanent Link Pattern</th>
                                    <td id="permanentLinkPattern" class="textLeft"></td>
                                </tr>
                                <tr>
                                    <th>Client ID</th>
                                    <td id="clientId" class="textLeft"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <div class="col">
                    <!-- WOFF DATA -->
                    <h2 id="woffDataHeader" class="textLeft">WOFF Data</h2>
                    <table class="table">
                        <tr>
                            <th>OS</th>
                            <td id="deviceOS" class="textLeft"></td>
                        </tr>
                        <tr>
                            <th>Language</th>
                            <td id="browserLanguage" class="textLeft"></td>
                        </tr>
                        <tr>
                            <th>WOFF SDK Version</th>
                            <td id="sdkVersion" class="textLeft"></td>
                        </tr>
                        <tr>
                            <th>LINEWORKS Version</th>
                            <td id="lineWorksVersion" class="textLeft"></td>
                        </tr>
                        <tr>
                            <th>isInClient</th>
                            <td id="isInClient" class="textLeft"></td>
                        </tr>
                        <tr>
                            <th>isLoggedIn</th>
                            <td id="isLoggedIn" class="textLeft"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <!-- ACCESS TOKEN DATA -->
                <h2>Access Token</h2>
                <button id="getAccessToken" class="btn btn-primary">Get Access Token</button>
                <div class="table-responsive">
                    <table>
                        <tr>
                            <th>accessToken</th>
                            <td id="accessTokenField"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div class="row p-1">
                <!-- WINDOW -->
                <h2>Window</h2>
                <div class="col">
                    <button id="openWindowButton" class="btn btn-primary">Open External Window</button>
                    <button id="closeWindowButton" class="btn btn-primary">Close WOFF App</button>
                </div>
            </div>

        </div>


        <!-- WOFF code -->
        <script type="module">
            // WOFF ID
            const woffId = "!!!!! Your WOFF ID !!!!!";

            window.onload = function() {
                console.log(woffId)
                initializeWoffOrDie(woffId);
            };

            /**
            * Check if myWoffId is null. If null do not initiate woff.
            * @param {string} myWoffId The WOFF ID of the selected element
            */
            function initializeWoffOrDie(myWoffId) {
                if (!myWoffId) {
                    //document.getElementById("woffAppContent").hidden = true;
                    document.getElementById("woffIdErrorMessage").hidden = false;
                } else {
                    console.log(myWoffId)
                    initializeWoff(myWoffId);
                }
            }

            /**
            * Initialize WOFF
            * @param {string} myWoffId The WOFF ID of the selected element
            */
            function initializeWoff(myWoffId) {
                woff
                    .init({
                        woffId: myWoffId
                    })
                    .then(() => {
                        console.log(woff)
                        // start to use WOFF's api
                        initializeApp();
                    })
                    .catch((err) => {
                        console.log(err)
                        //document.getElementById("woffAppContent").hidden = true;
                        document.getElementById("woffInitErrorMessage").hidden = false;
                    });
            }

            /**
             * Initialize the app by calling functions handling individual app components
             */
            function initializeApp() {
                displayWoffData();
                displayIsInClientInfo();
                registerButtonHandlers();

                // check if the user is logged in/out, and disable inappropriate button
                if (woff.isLoggedIn()) {
                    document.getElementById('woffLoginButton').disabled = true;
                } else {
                    document.getElementById('woffLogoutButton').disabled = true;
                }
            }

            /**
            * Display data generated by invoking WOFF methods
            */
            function displayWoffData() {
                document.getElementById('browserLanguage').textContent = woff.getLanguage();
                document.getElementById('sdkVersion').textContent = woff.getVersion();
                document.getElementById('lineWorksVersion').textContent = woff.getWorksVersion();
                document.getElementById('isInClient').textContent = woff.isInClient();
                document.getElementById('isLoggedIn').textContent = woff.isLoggedIn();
                document.getElementById('deviceOS').textContent = woff.getOS();

                var context = woff.getContext();
                console.log(context)
                document.getElementById('viewType').textContent = context.viewType;
                document.getElementById('endpointUrl').textContent = context.endpointUrl;
                document.getElementById('permanentLinkPattern').textContent = context.permanentLinkPattern;
                document.getElementById('clientId').textContent = context.clientId;
            }

            /**
            * Toggle the login/logout buttons based on the isInClient status, and display a message accordingly
            */
            function displayIsInClientInfo() {
                if (woff.isInClient()) {
                    //document.getElementById('woffLoginButton').classList.toggle('hidden');
                    //document.getElementById('woffLogoutButton').classList.toggle('hidden');
                    document.getElementById('isInClientMessage').textContent = 'You are opening the app in the in-app browser of LINE WORKS.';
                } else {
                    document.getElementById('isInClientMessage').textContent = 'You are opening the app in an external browser.';
                }
            }

            /**
            * Register event handlers for the buttons displayed in the app
            */
            function registerButtonHandlers() {
                // openWindow call
                document.getElementById('openWindowButton').addEventListener('click', function() {
                    woff.openWindow({
                        url: 'https://line.worksmobile.com/',
                        external: true
                    });
                });

                // closeWindow call
                document.getElementById('closeWindowButton').addEventListener('click', function() {
                    if (!woff.isInClient()) {
                        sendAlertIfNotInClient();
                    } else {
                        woff.closeWindow();
                    }
                });

                // sendMessage call
                document.getElementById('sendMessageButton').addEventListener('click', function() {
                    if (!woff.isInClient()) {
                        sendAlertIfNotInClient();
                    } else {
                        let msg = document.getElementById('sendMessageText').value
                        woff.sendMessage({
                            'content': msg
                        }).then(function() {
                            console.log("message sent: " + msg)
                            window.alert('Message sent');
                        }).catch(function(error) {
                            console.log(error)
                            window.alert('Error sending message: ' + error);
                        });
                    }
                });

                // get access token
                document.getElementById('getAccessToken').addEventListener('click', function() {
                    if (!woff.isLoggedIn() && !woff.isInClient()) {
                        alert('To get an access token, you need to be logged in. Please tap the "login" button below and try again.');
                    } else {
                        const accessToken = woff.getAccessToken();
                        document.getElementById('accessTokenField').textContent = accessToken;
                        //toggleAccessToken();
                    }
                });

                // get profile call
                document.getElementById('getProfileButton').addEventListener('click', function() {
                    woff.getProfile().then(function(profile) {
                        console.log(profile)
                        document.getElementById('domainIdField').textContent = profile.domainId;
                        document.getElementById('userIdProfileField').textContent = profile.userId;
                        document.getElementById('displayNameField').textContent = profile.displayName;
                        //toggleProfileData();
                    }).catch(function(error) {
                        console.log(error)
                        window.alert('Error getting profile: ' + error);
                    });
                });

                // login call, only when external browser is used
                document.getElementById('woffLoginButton').addEventListener('click', function() {
                    if (!woff.isLoggedIn()) {
                        // set `redirectUri` to redirect the user to a URL other than the front page of your WOFF app.
                        woff.login();
                    }
                });

                // logout call only when external browse
                document.getElementById('woffLogoutButton').addEventListener('click', function() {
                    if (woff.isLoggedIn()) {
                        woff.logout();
                        window.location.reload();
                    }
                });

                // scan QR
                document.getElementById('scanQrButton').addEventListener('click', function() {
                    woff.scanQR().then(function(result) {
                        console.log(result)
                        console.log(result.value)
                        document.getElementById('scanQrResult').textContent = result.value;
                    }).catch(function(error) {
                        console.log(error)
                        window.alert('Error scanning QR: ' + error);
                    });
                });
            }

            /**
            * Alert the user if WOFF is opened in an external browser and unavailable buttons are tapped
            */
            function sendAlertIfNotInClient() {
                alert('This button is unavailable as WOFF is currently being opened in an external browser.');
            }

            /**
            * Toggle access token data field
            */
            function toggleAccessToken() {
                toggleElement('accessTokenData');
            }

            /**
            * Toggle profile info field
            */
            function toggleProfileData() {
                toggleElement('profileInfo');
            }

            /**
            * Toggle specified element
            * @param {string} elementId The ID of the selected element
            */
            function toggleElement(elementId) {
                const elem = document.getElementById(elementId);
                if (elem.offsetWidth > 0 && elem.offsetHeight > 0) {
                    elem.style.display = 'none';
                } else {
                    elem.style.display = 'block';
                }
            }
        </script>
    </body>
</html>

